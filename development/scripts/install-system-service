#!/usr/bin/env bash

# this script will install solar protocol as a systemd service

# set current working directory to the same as this file 
cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null

set -o errexit
set -o nounset

if ! systemd-notify --booted; then
  echo "Script only meant to be run on a systemd managed system" >&2
  exit 1
fi 

unit_path=/etc/systemd/system

echo "installing system services to $unit_path"

export project_directory=$(realpath ${PWD}/../..)
for template in solar-protocol*template; do
  echo "installing $template"
  envsubst < $template | sudo tee $unit_path/${template%%.template}
done

echo "(re)loading solar-protocol service"
sudo systemctl daemon-reload

if systemctl is-active solar-protocol.target; then
  echo "stopping solar-protocol"
  sudo systemctl stop solar-protocol.target
fi

if ! systemctl is-enabled solar-protocol.target; then
  echo "enabling system service"
  sudo systemctl enable solar-protocol.target
fi

if ! systemctl is-active solar-protocol.target; then
  echo "starting solar-protcool"
  sudo systemctl start solar-protocol.target
fi

echo 'printing status with `systemctl status solar-protocol.target`'
systemctl status solar-protocol.target

echo 'to view logs, run `journalctl -uf solar-protocol*`'
