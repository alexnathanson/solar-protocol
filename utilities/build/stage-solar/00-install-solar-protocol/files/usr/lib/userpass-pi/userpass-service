#!/bin/sh -e

validate_password() {
    if [ -z "$NEW_PASS" ]; then
        echo "Password cannot be empty."
        return 1
    fi
}

if [ ! "$(raspi-config nonint get_boot_cli)" -eq 0 ]; then
    return
fi

VT="$(tty | sed 's|/dev/tty||')"
ORIG_VT="1"
if [ -t 0 ]; then
    chvt "$VT"
fi
FIRST_USER="$(getent passwd 1000 | cut -d: -f1)"

while true; do
    NEW_PASS="$(whiptail --passwordbox "Please set a password for $FIRST_USER:" 20 60 3>&1 1>&2 2>&3)"
    if [ "$(whiptail --passwordbox "Please confirm the password:" 20 60 3>&1 1>&2 2>&3)" != "$NEW_PASS" ]; then
        MSG="Passwords did not match"
    elif MSG=$(validate_password); then
        break
    fi
    whiptail --msgbox "$MSG" 20 60
done

echo "$FIRST_USER:$NEW_PASS" | chpasswd
chvt "$ORIG_VT"
